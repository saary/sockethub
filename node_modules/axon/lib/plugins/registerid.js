
/**
 * Module dependencies.
 */

var debug = require('debug')('axon:register');
var RouterSocket = require('../sockets/router');

/**
 * Register Id plugin.
 *
 * registers a socket with a router on connection.
 *
 * Emits:
 *  - `registered` (code) when the socket is registered
 *
 * @param {Object} options
 * @api private
 */

module.exports = function (options) {
  options = options || {};

  return function (sock) {
    if (!sock.identity) throw new Error('sock must have an identity');

    sock.on('connect', function (socket) {
      if (socket.writable) {
        var args = [{ id: sock.identity, type: RouterSocket.REGISTER }, sock.identity + ':register'];
        socket.write(sock.pack(args));
      }

      sock.on('message', function (code) {
        sock.emit('registered', code);
      });
    });
  };
};

